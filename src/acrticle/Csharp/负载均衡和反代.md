---
title: 负载均衡和反代
icon: code
order: 27
category:
  - C#学习
tag:
  - 负载均衡
  - 反代
---

# ASP.NET Core YARP 负载均衡配置指南

## 概述

本文档介绍如何使用 YARP（Yet Another Reverse Proxy）在 ASP.NET Core 项目中实现负载均衡和反向代理功能。

## 1. 安装 YARP 包

首先，在你的 ASP.NET Core 项目中安装 YARP 包：

```bash
dotnet add package Microsoft.ReverseProxy
```

## 2. 配置 Program.cs

在 `Program.cs` 中配置 YARP 进行负载均衡，需要增加以下两行代码：

```csharp
// 添加 YARP 服务
builder.Services.AddReverseProxy()
    .LoadFromConfig(builder.Configuration.GetSection("ReverseProxy"));

// 启用反向代理中间件
app.MapReverseProxy();
```

### 配置参数说明

| 参数 | 说明 | 示例 |
|------|------|------|
| `AddReverseProxy()` | 添加 YARP 服务到依赖注入容器 | 必需 |
| `LoadFromConfig()` | 从配置文件中加载代理配置 | 必需 |
| `MapReverseProxy()` | 启用反向代理中间件 | 必需 |
| `GetSection("ReverseProxy")` | 获取配置文件中的 ReverseProxy 节 | 必需 |

## 3. 配置 appsettings.json

在 `appsettings.json` 中配置后端服务、路由和健康检查：

```json
{
  "ReverseProxy": {
    "Routes": {
      "device_route": {
        "ClusterId": "device_cluster",
        "Match": {
          "Path": "/api/device/GetAllDevices"
        }
      }
    },
    "Clusters": {
      "device_cluster": {
        "LoadBalancing": {
          "Mode": "RoundRobin"
        },
        "HealthCheck": {
          "Active": {
            "Enabled": true,
            "Interval": "00:00:10",
            "Timeout": "00:00:05",
            "Path": "/api/Health/Check",
            "Policy": "ConsecutiveFailures",
            "ConsecutiveFailures": 2
          }
        },
        "Destinations": {
          "service_6767": {
            "Address": "http://23.78.85.99:6767/"
          },
          "service_7878": {
            "Address": "http://23.78.85.99:7878/"
          }
        }
      }
    }
  }
}
```

### 配置项详解

#### 路由配置 (Routes)

| 配置项 | 说明 | 示例值 |
|--------|------|--------|
| `device_route` | 路由名称 | 自定义 |
| `ClusterId` | 关联的集群 ID | `device_cluster` |
| `Match.Path` | 匹配的 URL 路径 | `/api/device/GetAllDevices` |

#### 集群配置 (Clusters)

| 配置项 | 说明 | 示例值 |
|--------|------|--------|
| `device_cluster` | 集群名称 | 自定义 |
| `LoadBalancing.Mode` | 负载均衡算法 | `RoundRobin` |
| `HealthCheck.Active.Enabled` | 是否启用主动健康检查 | `true` |
| `HealthCheck.Active.Interval` | 健康检查间隔 | `00:00:10` |
| `HealthCheck.Active.Timeout` | 健康检查超时时间 | `00:00:05` |
| `HealthCheck.Active.Path` | 健康检查端点路径 | `/api/Health/Check` |
| `HealthCheck.Active.Policy` | 健康检查策略 | `ConsecutiveFailures` |
| `HealthCheck.Active.ConsecutiveFailures` | 连续失败次数阈值 | `2` |

#### 目标服务配置 (Destinations)

| 服务标识 | 地址 |
|----------|------|
| `service_6767` | `http://23.78.85.99:6767/` |
| `service_7878` | `http://23.78.85.99:7878/` |

### 支持的负载均衡算法

| 算法名称 | 说明 |
|----------|------|
| `RoundRobin` | 轮询算法 |
| `LeastRequests` | 最少请求算法 |
| `Random` | 随机算法 |
| `PowerOfTwoChoices` | 两次随机选择最优算法 |

### 支持的健康检查策略

| 策略名称 | 说明 |
|----------|------|
| `ConsecutiveFailures` | 连续失败策略 |
| `HealthyAndReady` | 健康且就绪策略 |

## 4. 完整示例

### 完整的 Program.cs 示例

```csharp
var builder = WebApplication.CreateBuilder(args);

// 添加服务到容器
builder.Services.AddControllers();
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

// 添加 YARP 服务
builder.Services.AddReverseProxy()
    .LoadFromConfig(builder.Configuration.GetSection("ReverseProxy"));

var app = builder.Build();

// 配置 HTTP 请求管道
if (app.Environment.IsDevelopment())
{
    // app.UseSwagger();
    // app.UseSwaggerUI();
}

// 启用反向代理中间件
app.MapReverseProxy();

app.UseHttpsRedirection();
app.UseAuthorization();
app.MapControllers();

app.Run();
```

### 完整的 appsettings.json 示例

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.ReverseProxy": "Information"
    }
  },
  "AllowedHosts": "*",

  "ReverseProxy": {
    "Routes": {
      "device_route": {
        "ClusterId": "device_cluster",
        "Match": {
          "Path": "/api/device/GetAllDevices"
        }
      }
    },
    "Clusters": {
      "device_cluster": {
        "LoadBalancing": {
          "Mode": "RoundRobin"
        },
        "HealthCheck": {
          "Active": {
            "Enabled": true,
            "Interval": "00:00:10",
            "Timeout": "00:00:05",
            "Path": "/api/Health/Check",
            "Policy": "ConsecutiveFailures",
            "ConsecutiveFailures": 2
          }
        },
        "Destinations": {
          "service_6767": {
            "Address": "http://10.1.193.243:6767/"
          },
          "service_7878": {
            "Address": "http://10.1.193.243:7878/"
          }
        }
      }
    }
  }
}
```

## 5. 注意事项

1. **健康检查端点**：确保后端服务实现了 `/api/Health/Check` 端点，返回正确的健康状态
2. **端口配置**：根据实际部署环境修改目标服务的 IP 地址和端口
3. **HTTPS 配置**：生产环境中建议使用 HTTPS
4. **日志级别**：适当调整 `Microsoft.ReverseProxy` 的日志级别以便调试

## 6. 总结

通过以上配置，你的 ASP.NET Core 应用将具备：
- 反向代理功能
- 负载均衡能力
- 健康检查机制
- 自动故障转移